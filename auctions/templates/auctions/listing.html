{% extends 'auctions/layout.html' %}
{% load static %}

{% block body %}
<h2>Listing: {{ listing.title }}</h2>

{% if user.is_authenticated %}
<!-- Watchlist Button -->
<button class="watchlist-button btn {% if watch %}btn-secondary{% else %}btn-outline-secondary{% endif %}" 
        data-listing="{{ listing.title }}">
    {% if watch %}- Watchlist{% else %}+ Watchlist{% endif %}
</button>

<!-- Like Button -->
<div class="like-section my-2">
    <button id="like-button" class="btn {% if user in listing.likes.all %}btn-danger{% else %}btn-outline-danger{% endif %} btn-sm" 
            data-listing-id="{{ listing.id }}">
        <i class="bi {% if user in listing.likes.all %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
        <span id="like-count">{{ listing.likes.count }}</span>
    </button>
</div>
{% endif %}

<div class="row">
    <div class="col-md-8">
        <img src="{{ listing.image_url }}" class="listing-detail-image" alt="{{ listing.title }}">
    </div>
</div>

<p>{{ listing.description }}</p>
<h4 id="current-price">${{ listing.current_price }}</h4>

{% if user.is_authenticated %}
    {% if user == listing.seller %}
        <form action="{% url 'close' title=listing.title %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="close" value="close">
            <button type="submit" class="btn btn-secondary mt-2">Close Auction</button>
        </form>
    {% elif condition and listing.status == "closed" %}
        <h4 class="text-success mt-3">You have won the auction</h4>
    {% elif listing.status == "closed" %}
        <h4 class="mt-3">Auction is closed</h4>
    {% else %}
        {% if user.user_type in 'bidder,both' %}
            <!-- Bid Form -->
            <form id="bid-form" data-listing="{{ listing.title }}">
                {% csrf_token %}
                <div id="bid-message" class="mb-2"></div>
                <span id="bid-count">{{ bids }} bid(s) so far.</span>
                {% if condition %}
                    <span id="current-bid-message" class="text-success">Your bid is the current bid</span>
                {% endif %}
                <br>
                <input class="form-control mt-2" id="bid-input" type="number" placeholder="Bid" required>
                <button type="submit" class="btn btn-primary mt-2">Place Bid</button>
            </form>
        {% else %}
            <div class="alert alert-warning mt-3" role="alert">
                You need to be a bidder to place bids. Please update your account type.
            </div>
        {% endif %}
    {% endif %}
{% endif %}

<!-- Listing Details -->
<div class="mt-4">
    <h4>Details</h4>
    <ul>
        <li>Listed by: {{ listing.seller.username }}</li>
        <li>Category: {{ listing.category|default:"No Category Listed" }}</li>
    </ul>
</div>

<!-- Comments Section -->
<div class="mt-4">
    <h3>Comments</h3>
    <div id="comments-section">
        {% for comment in comments %}
        <div>
            <h5 class="text-primary">{{ comment.writer.username }}</h5>
            <p>{{ comment.comment }}</p>
            <hr>
        </div>
        {% empty %}
        <h5>No Comments</h5>
        {% endfor %}
    </div>

    {% if user.is_authenticated %}
    <form id="comment-form" data-listing="{{ listing.title }}" class="mt-3">
        {% csrf_token %}
        <input class="form-control" id="comment-input" type="text" name="comment" placeholder="Write a comment..." required>
        <button type="submit" class="btn btn-primary mt-2">Comment</button>
    </form>
    {% endif %}
</div>

<!-- Styles -->
<style>
    .listing-detail-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        margin-bottom: 20px;
    }
</style>

{% block script %}
<script src="{% static 'auctions/auctions.js' %}"></script>
{% endblock %}
{% endblock %}
